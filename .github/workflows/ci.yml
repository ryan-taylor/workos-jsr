name: CI
on:
  # triggers for pushes & PRs
  push: { branches: ["**"] }
  pull_request: {}
  # scheduled workflow trigger for canary specs
  schedule:
    - cron: '0 2 * * 0'  # Run at 02:00 UTC every Sunday

jobs:
  codegen:
    name: Generate SDK Code üìù
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.value }}
    steps:
      - uses: actions/checkout@v4.2.2
      - uses: denoland/setup-deno@v1
        with: { deno-version: "2.x" }

      # Generate cache key based on spec checksum and deno.lock
      - name: Generate cache key
        id: cache-key
        run: |
          SPECS_CHECKSUM=$(find ./vendor/openapi -name 'workos-*.json' -type f | sort | xargs sha256sum | sha256sum | cut -d ' ' -f1)
          DENO_LOCK_CHECKSUM=$(sha256sum deno.lock | cut -d ' ' -f1)
          CACHE_KEY="codegen-${{ github.ref_name }}-${SPECS_CHECKSUM}-${DENO_LOCK_CHECKSUM}"
          echo "value=${CACHE_KEY}" >> $GITHUB_OUTPUT
          echo "Cache key: ${CACHE_KEY}"

      # Try to restore generated files from cache
      - name: Restore generated files from cache
        id: cache-generated
        uses: actions/cache@v4
        with:
          path: packages/workos_sdk/generated
          key: ${{ steps.cache-key.outputs.value }}
          restore-keys: |
            codegen-${{ github.ref_name }}-
            codegen-main-

      # Generate SDK code if not in cache
      - name: Generate SDK code
        if: steps.cache-generated.outputs.cache-hit != 'true'
        run: deno task generate:api
        env:
          CANARY_SPECS: ${{ github.event_name == 'schedule' && 'true' || 'false' }}

      # Validate OpenAPI Spec Checksums
      - name: Validate OpenAPI Spec Checksums
        run: deno run -A scripts/ci/validate-spec-checksums.ts
        
      # Upload generated files as an artifact for other jobs
      - name: Upload generated code as artifact
        uses: actions/upload-artifact@v4
        with:
          name: generated-code
          path: packages/workos_sdk/generated
          retention-days: 1
 
  lint_unit:
    name: Lint üßπ & Test üß™
    needs: codegen
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.2.2
      - uses: denoland/setup-deno@v1
        with: { deno-version: "2.x" }
      
      # Download generated code from previous job
      - name: Download generated code
        uses: actions/download-artifact@v4
        with:
          name: generated-code
          path: packages/workos_sdk/generated
      
      - name: Deno Lint
        run: deno lint
      
      - name: Detect npm specifiers
        run: |
          if grep -R --line-number --exclude-dir=.git -E '["'"'"']npm:' .; then
            echo "::error ::npm imports detected";
            exit 1;
          fi
      
      - name: Check for npm dependencies
        run: |
          if deno info --json | jq -e '.modules[] | select(.specifier | startswith("npm:"))' > /dev/null; then
            echo "::error::npm dependencies detected in the project"
            deno info --json | jq '.modules[] | select(.specifier | startswith("npm:")) | .specifier'
            exit 1
          fi
      
      - name: Unit & Integration Tests
        run: deno test -A

  type_check:
    name: Type Check üîç
    needs: codegen
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4.2.2
      - uses: denoland/setup-deno@v1
        with: { deno-version: "2.x" }
      
      # Download generated code from previous job
      - name: Download generated code
        uses: actions/download-artifact@v4
        with:
          name: generated-code
          path: packages/workos_sdk/generated
      
      - name: Deno Type-Check
        run: deno check $(git ls-files '*.ts')
